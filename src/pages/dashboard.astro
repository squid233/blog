---
import Markdown from "@components/misc/Markdown.astro";
import type { AuthResponse } from "@supabase/supabase-js";
import MainGridLayout from "../layouts/MainGridLayout.astro";
import { supabase } from "../lib/supabase";

const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
	return Astro.redirect("/signin");
}

let session: AuthResponse;
try {
	session = await supabase.auth.setSession({
		refresh_token: refreshToken.value,
		access_token: accessToken.value,
	});
	if (session.error) {
		Astro.cookies.delete("sb-access-token", {
			path: "/",
		});
		Astro.cookies.delete("sb-refresh-token", {
			path: "/",
		});
		return Astro.redirect("/signin");
	}
} catch (error) {
	Astro.cookies.delete("sb-access-token", {
		path: "/",
	});
	Astro.cookies.delete("sb-refresh-token", {
		path: "/",
	});
	return Astro.redirect("/signin");
}

const email = session.data.user?.email;
---
<MainGridLayout title="仪表板">
    <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
        <div class="card-base z-10 px-9 py-6 relative w-full ">
          <Markdown class="mt-2">
			<h1>欢迎 {email}</h1>
			<p>我们很高兴在这里见到你</p>
			<form action="/api/auth/signout">
				<button type="submit" class="btn-regular scale-animation rounded-lg w-20 h-12">退出登录</button>
			</form>
          </Markdown>
        </div>
    </div>
</MainGridLayout>